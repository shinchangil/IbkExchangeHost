using NLog;
using System.Net.Sockets;
using System.Net;
using System.Text;


/*
 case 1: 기본 인코딩
    - Encoding euckr = Encoding.UTF8; 
 case 2: 한글 인코딩
    - Encoding.GetEncoding("euc-kr").GetString(...);
 case 3: 한글 인코딩
    - Encoding.RegisterProvider(CodePagesEncodingProvider.Instance);
      Encoding euckr = Encoding.GetEncoding(949);
*/
namespace ExchangeTest
{
    public class Program
    {
        static void Main(string[] args)
        {
            int encoding_case = 1;
            //  DB에 넣어서 부를때 마다 증가하도록 설정
            Int32 requestSeq = 0;

            //  EAI 서버 주소 환경설정으로 이동
            //String ipAddress = "172.18.190.83";
            //String ipAddress = "";

            ///docker 올리기
            ///docker run -itd --name catus -v `pwd`:/home/castware/agent rockeybaseimage:1.0
            ///docker exec -it catus /bin/bash
            ///docker 내부 경로: /home/castware/agent
            /////////////////////////////////////////////////////////////////////////////////////////////////
            ///로그 파일을 위한
            var current = AppDomain.CurrentDomain.BaseDirectory;
            if (!Directory.Exists(AppDomain.CurrentDomain.BaseDirectory + "log"))
            {
                Directory.CreateDirectory(AppDomain.CurrentDomain.BaseDirectory + "log");
            }

            LogManager.Setup().LoadConfigurationFromFile("nlogCatus.config");
            var logger = LogManager.GetCurrentClassLogger();
            /////////////////////////////////////////////////////////////////////////////////////////////////
            ///환경설정 파일 읽고 쓰기
            CFileConfig cFileConfig = new CFileConfig(AppDomain.CurrentDomain.BaseDirectory + "myConf.ini");
            //cFileConfig.MyWriteIni("http://", "testError");
            cFileConfig.LoadIni();
            //logger.Info("Play url : " + cFileConfig.Play_URL);
            //logger.Info("WriteTime : " + cFileConfig.WriteTime);
            //logger.Info("ErrCode : " + cFileConfig.ErrCode);
            /////////////////////////////////////////////////////////////////////////////////////////////////
            ///

            ///TCP Server
            //CTCPServer server = new CTCPServer("0.0.0.0", cFileConfig.EaiListenPort);
            //Thread threadServer = new Thread(server.Execute);
            //threadServer.IsBackground = true;
            //threadServer.Start();
            //Thread.Sleep(6000);
            ////////////////////////////////////////////////////////////////////////////////////////////////

            ibkEAIPacketRequest1 _base1 = new ibkEAIPacketRequest1(
                requestSeq, 
                cFileConfig.EaiListenIpAddress, 
                cFileConfig.EaiListenMac, 
                cFileConfig.EaiIpaddress, 
                cFileConfig.EaiListenPort
            );
        
            ibkEAIPacketRequest2 _base2 = new ibkEAIPacketRequest2();
            ibkEAIPacketRequest3 _base3 = new ibkEAIPacketRequest3();
            ibkEAIPacketRequestExchange _request = new ibkEAIPacketRequestExchange();

            String _date = String.Empty;
            //Int32 _startPos = 0;
            Boolean _isHost = true;

            if (args.Length == 1)
            {
                encoding_case = int.Parse(args[0]);
            }

            //if (args.Length == 2) 
            //{
            //    _isHost = Boolean.Parse(args[0]);
            //    _date = args[1];
            //}

            var _sendPacket = _base1.GetPacket(_isHost, _base2.GetPacket() + _base3.GetPacket() + _request.GetPacket(_isHost, _date));

            String _sample = String.Empty;

            //var 
            //var _hostSample = @"009313Y1KO02420241101NFB00000280067160000030000000420241101NFB00000020241101144035764172.18.121.197                         005056803AABD20241101144035764N000EAI0000000020241106144038138R00000NFBNFBNFBO00084444SN020241101144035764CBKFEX508012                                172.18.190.83                          09999dmca0101CBK2024110614403810300               NFBNFBNFB0000000000000000000000 N20241101NFBO00083530000000000000                      OLTNFBCBKFEX508012800800      000000000N100000000001001000                                                                                                                                                                                                MC0001240885C06  0000FS04240311                                  0000000N0885000000000-99999999999999-99999999999999-99999999999999NNC000597                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                00000                                                                                                                OF0000180101         0 000IO0078460885�۷ι��ڱݱ�                                      20241106144035C0603                                                                                                                                    2024110611553001794      0179400000                                                                                                    00688.10000000451.99000002339.54000001536.74000000058 USDKRW01363.20000001389.20000001352.12000001400.28000000000.00000001376.20000000001.00000000006.64050001376.2000000017500175*JPYKRW00895.39000000912.55000000888.16000000919.78000000000.00000000903.97000000000.65690000002.18460000152.2400000017500175 EURKRW01481.99000001510.41000001466.73000001525.67000000000.00000001496.20000000001.08720000005.09800000001.0872000019700197 GBPKRW01765.66000001799.52000001747.48000001817.70000000000.00000001782.59000000001.29530000006.84000000001.2953000019700197 AUDKRW00898.58000000915.80000000889.41000000924.97000000000.00000000907.19000000000.65920000006.30960000000.6592000019600196 NZDKRW00816.25000000831.89000000807.92000000840.22000000000.00000000824.07000000000.59880000006.77000000000.5988000019600196 CHFKRW01571.33000001601.47000001555.31000001617.49000000000.00000001586.40000000001.15270000002.71000000000.8675000019600196 CADKRW00979.19000000997.97000000969.21000001007.95000000000.00000000988.58000000000.71830000005.71000000001.3921000019600196 DKKKRW00198.80000000202.60000000196.69000000204.71000000000.00000000200.70000000000.14580000005.10670000006.8571000020000200 NOKKRW00123.76000000126.12000000122.45000000127.43000000000.00000000124.94000000000.09080000006.68000000011.0150000020000200 SEKKRW00127.54000000129.98000000126.19000000131.33000000000.00000000128.76000000000.09360000004.93000000010.6881000020000200 HKDKRW00175.29000000178.65000000173.51000000180.43000000000.00000000176.97000000000.12860000006.05000000007.7766000019600196 SGDKRW01030.88000001050.64000001020.26000001061.26000000000.00000001040.76000000000.75630000005.28000000001.3223000019700197 THBKRW00040.28000000041.04000000038.23000000043.09000000000.00000000040.66000000000.02950000004.30000000033.8500000060000600 SARKRW00362.94000000369.90000000342.61000000381.07000000000.00000000366.42000000000.26630000007.51000000003.7557500065000400 AEDKRW00371.13000000378.23000000355.95000000389.66000000000.00000000374.68000000000.27230000005.10000000003.6730000050000400 KWDKRW04446.96000004532.26000004175.34000004669.19000000000.00000004489.61000000003.26230000004.50000000000.3065300070000400 BHDKRW03615.44000003684.78000003358.11000003796.11000000000.00000003650.11000000002.65230000008.38000000000.3770300080000400 MYRKRW00311.40000000317.36000000298.67000000326.95000000000.00000000314.38000000000.22840000005.29000000004.3775000050000400*IDRKRW00008.67000000008.83000000008.23000000009.27000000000.00000000008.75000000000.00640000008.65000015                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ";

            //if (_isHost)
            //{
            //    _startPos = 1463;
            //    _sample = @"009313Y1KO02420241101NFB00000280067160000030000000420241101NFB00000020241101144035764172.18.121.197                         005056803AABD20241101144035764N000EAI0000000020241106144038138R00000NFBNFBNFBO00084444SN020241101144035764CBKFEX508012                                172.18.190.83                          09999dmca0101CBK2024110614403810300               NFBNFBNFB0000000000000000000000 N20241101NFBO00083530000000000000                      OLTNFBCBKFEX508012800800      000000000N100000000001001000                                                                                                                                                                                                MC0001240885C06  0000FS04240311                                  0000000N0885000000000-99999999999999-99999999999999-99999999999999NNC000597                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                00000                                                                                                                OF0000180101         0 000IO0078460885�۷ι��ڱݱ�                                      20241106144035C0603                                                                                                                                    2024110611553001794      0179400000                                                                                                    00688.10000000451.99000002339.54000001536.74000000058 USDKRW01363.20000001389.20000001352.12000001400.28000000000.00000001376.20000000001.00000000006.64050001376.2000000017500175*JPYKRW00895.39000000912.55000000888.16000000919.78000000000.00000000903.97000000000.65690000002.18460000152.2400000017500175 EURKRW01481.99000001510.41000001466.73000001525.67000000000.00000001496.20000000001.08720000005.09800000001.0872000019700197 GBPKRW01765.66000001799.52000001747.48000001817.70000000000.00000001782.59000000001.29530000006.84000000001.2953000019700197 AUDKRW00898.58000000915.80000000889.41000000924.97000000000.00000000907.19000000000.65920000006.30960000000.6592000019600196 NZDKRW00816.25000000831.89000000807.92000000840.22000000000.00000000824.07000000000.59880000006.77000000000.5988000019600196 CHFKRW01571.33000001601.47000001555.31000001617.49000000000.00000001586.40000000001.15270000002.71000000000.8675000019600196 CADKRW00979.19000000997.97000000969.21000001007.95000000000.00000000988.58000000000.71830000005.71000000001.3921000019600196 DKKKRW00198.80000000202.60000000196.69000000204.71000000000.00000000200.70000000000.14580000005.10670000006.8571000020000200 NOKKRW00123.76000000126.12000000122.45000000127.43000000000.00000000124.94000000000.09080000006.68000000011.0150000020000200 SEKKRW00127.54000000129.98000000126.19000000131.33000000000.00000000128.76000000000.09360000004.93000000010.6881000020000200 HKDKRW00175.29000000178.65000000173.51000000180.43000000000.00000000176.97000000000.12860000006.05000000007.7766000019600196 SGDKRW01030.88000001050.64000001020.26000001061.26000000000.00000001040.76000000000.75630000005.28000000001.3223000019700197 THBKRW00040.28000000041.04000000038.23000000043.09000000000.00000000040.66000000000.02950000004.30000000033.8500000060000600 SARKRW00362.94000000369.90000000342.61000000381.07000000000.00000000366.42000000000.26630000007.51000000003.7557500065000400 AEDKRW00371.13000000378.23000000355.95000000389.66000000000.00000000374.68000000000.27230000005.10000000003.6730000050000400 KWDKRW04446.96000004532.26000004175.34000004669.19000000000.00000004489.61000000003.26230000004.50000000000.3065300070000400 BHDKRW03615.44000003684.78000003358.11000003796.11000000000.00000003650.11000000002.65230000008.38000000000.3770300080000400 MYRKRW00311.40000000317.36000000298.67000000326.95000000000.00000000314.38000000000.22840000005.29000000004.3775000050000400*IDRKRW00008.67000000008.83000000008.23000000009.27000000000.00000000008.75000000000.00640000008.65000015                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ";
            //}
            //else
            //{ 
            //    _startPos = 1437;
            //    _sample = @"002059N0KO02420240807NFB00000280067160000030000000320240807NFB00000020240807065328261172.18.202.28                          ************D20240807155328312N000EAI0000000020240807155328437R00000NFBCTANFBO00083530SN020240807155328312                                    00000000                                       00000        CTS2024080715532831200               NFBNFBNFB                                                      00                      OLTNFB                                  100000000000001000                                                                                                                                                                                                MC000124         0000CHCTS00011        22                        0000000           000000000000000000000000000000000000000000000000 NC000597                                                                                                      ********************                    ****************                                                                                                                                                                                                                                                                                                                                  00000                                                                                                                IO000618202408070095600008USD01378.10000000001.00000001365.10000001391.10000001353.99000001402.210000JPY00938.25000000146.88000000929.34000000947.16000000921.84000000954.660000CNY00191.77000000007.18640000189.95000000193.59000000182.19000000201.350000EUR01502.96000000001.09060001488.69000001517.23000001473.36000001532.560000GBP01750.05000000001.26990001733.43000001766.67000001715.58000001784.520000CAD01000.15000000001.37790000990.65000001009.65000000980.55000001019.750000AUD00902.52000000000.65490000893.95000000911.09000000884.84000000920.200000CHF01608.05000000000.85700001592.78000001623.32000001576.54000001639.560000@@";
            //}
            _sample = @"009313Y1KO02420250827NFB00000280067160000030000000420250827NFB00000020250827180822164172.18.94.189                          00505696c664P20250827180822164N000EAI0000000020250901180822474R00000NFBNFBNFBO00084444SN020250827180822164CBKFEX508012                                172.18.66.50                           09999dmca0101CBK2025090118082246000               NFBNFBNFB0000000000000000000000 N20250827NFBO00083530000000000000                      OLTNFBCBKFEX508012800800      000000000N100000000001001000                                                                                                                                                                                                MC0001240885C06  0000FS04240311                                  0000000N0885000000000-99999999999999-99999999999999-99999999999999NNC000597                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                00000                                                                                                                OF0000180101         0 000IO0078460885글로벌자금그                                      20250901180822C0603                                                                                                                                    2025090118080401125      0112500000                                                                                                    00696.10000000473.35000002366.74000001609.37000000058 USDKRW01379.00000001405.40000001367.84000001416.56000000000.00000001392.20000000001.00000000006.27260001392.2000000017500175*JPYKRW00937.70000000955.68000000930.13000000963.25000000000.00000000946.69000000000.68000000002.44180000147.0600000017500175 EURKRW01617.26000001648.28000001600.61000001664.93000000000.00000001632.77000000001.17280000003.82900000001.1728000019700197 GBPKRW01866.04000001901.82000001846.82000001921.04000000000.00000001883.93000000001.35320000006.03000000001.3532000019700197 AUDKRW00904.06000000921.40000000894.85000000930.61000000000.00000000912.73000000000.65560000005.54750000000.6556000019600196 NZDKRW00815.53000000831.17000000807.22000000839.48000000000.00000000823.35000000000.59140000005.10000000000.5914000019600196 CHFKRW01725.88000001758.98000001708.28000001776.58000000000.00000001742.43000000001.25160000001.88000000000.7990000019600196 CADKRW01003.55000001022.79000000993.32000001033.02000000000.00000001013.17000000000.72770000004.62000000001.3741000019600196 DKKKRW00216.79000000220.93000000214.49000000223.23000000000.00000000218.86000000000.15720000003.91670000006.3612000020000200 NOKKRW00137.87000000140.51000000136.41000000141.97000000000.00000000139.19000000000.10000000006.25000000010.0024000020000200 SEKKRW00146.74000000149.54000000145.18000000151.10000000000.00000000148.14000000000.10640000004.21000000009.3978000020000200 HKDKRW00176.89000000180.27000000175.08000000182.08000000000.00000000178.58000000000.12830000005.20000000007.7961000019600196 SGDKRW01074.90000001095.50000001063.83000001106.57000000000.00000001085.20000000000.77950000003.63000000001.2829000019700197 THBKRW00042.72000000043.52000000040.54000000045.70000000000.00000000043.12000000000.03100000003.55000000032.2900000060000600 SARKRW00367.50000000374.54000000346.91000000385.86000000000.00000000371.02000000000.26650000007.72000000003.7524000065000400 AEDKRW00375.48000000382.68000000360.13000000394.24000000000.00000000379.08000000000.27230000005.10000000003.6726000050000400 KWDKRW04514.13000004600.71000004238.41000004739.71000000000.00000004557.42000000003.27350000004.50000000000.3054800070000400 BHDKRW03657.76000003727.92000003397.42000003840.55000000000.00000003692.84000000002.65250000007.82000000000.3770000080000400 MYRKRW00326.38000000332.64000000313.04000000342.69000000000.00000000329.51000000000.23670000005.02000000004.2250000050000400*IDRKRW00008.40000000008.56000000007.98000000008.98000000000.00000000008.48000000000.00610000007.30000016420.0000000060000600 CNYKRW00193.42000000197.12000000185.51000000205.03000000000.00000000195.27000000000.14030000003.69000000007.1297000050000500*VNDKRW00005.23000000005.33000000004.67000000005.89000000000.00000000005.28000000000.00380000000.00000026345.0000000117001170 PHPKRW00024.11000000024.57000000022.88000000026.53000000000.00000000024.34000000000.01750000000.00000000057.1925000060000900 TWDKRW00000.00000000000.00000000042.35000000049.17000000000.00000000045.53000000000.03270000000.00000000030.5755000070000800 CNHKRW00193.42000000197.12000000185.51000000205.03000000000.00000000195.27000000000.14030000003.69000000007.1297000050000500 KZTKRW00000.00000000000.00000000000.00000000000.00000000000.00000000002.59000000000.00190000000.00000000537.8300000000000000 INRKRW00015.64000000015.94000000000.00000000000.00000000000.00000000015.79000000000.01130000000.00000000088.1725000000000000 BDTKRW00000.00000000000.00000000000.00000000000.00000000000.00000000011.44000000000.00820000000.00000000121.7000000000000000 MNTKRW00000.00000000000.00000000000.00000000000.00000000000.00000000000.39000000000.00030000000.00000003596.0000000000000000 BNDKRW00000.00000000000.00000000000.00000000000.00000000000.00000001084.35000000000.77890000000.00000000001.2839000000000000 PKRKRW00000.00000000000.00000000000.00000000000.00000000000.00000000004.90000000000.00350000000.00000000283.8750000000000000 MXNKRW00000.00000000000.00000000000.00000000000.00000000000.00000000074.61000000000.05360000000.00000000018.6600000000000000 ARSKRW00000.00000000000.00000000000.00000000000.00000000000.00000000001.03000000000.00070000000.00000001347.0000000000000000 BRLKRW00000.00000000000.00000000000.00000000000.00000000000.00000000256.26000000000.18410000000.00000000005.4328500000000000 HUFKRW00000.00000000000.00000000000.00000000000.00000000000.00000000004.13000000000.00300000000.00000000337.3800000000000000 CZKKRW00000.00000000000.00000000000.00000000000.00000000000.00000000066.89000000000.04800000000.00000000020.8120000000000000 RUBKRW00000.00000000000.00000000000.00000000000.00000000000.00000000017.42000000000.01250000000.00000000079.9000000000000000 PLNKRW00379.78000000387.06000000000.00000000000.00000000000.00000000383.42000000000.27540000000.00000000003.6310000000000000 ILSKRW00000.00000000000.00000000000.00000000000.00000000000.00000000416.50000000000.29920000000.00000000003.3426000000000000 QARKRW00000.00000000000.00000000000.00000000000.00000000000.00000000380.90000000000.27360000000.00000000003.6550000000000000 JODKRW00000.00000000000.00000000000.00000000000.00000000000.00000001963.61000000001.41040000000.00000000000.7090000000000000 TRYKRW00000.00000000000.00000000000.00000000000.00000000000.00000000033.91000000000.02440000000.00000000041.0542500000000000 ZARKRW00000.00000000000.00000000000.00000000000.00000000000.00000000078.65000000000.05650000000.00000000017.7005500000000000 EGPKRW00000.00000000000.00000000000.00000000000.00000000000.00000000028.62000000000.02060000000.00000000048.6400000000000000 KHRKRW00000.00000000000.00000000000.00000000000.00000000000.00000000000.35000000000.00030000000.00000004008.0000000000000000 MMKKRW00000.00000000000.00000000000.00000000000.00000000000.00000000000.66000000000.00050000000.00000002100.0000000000000000 NPRKRW00000.00000000000.00000000000.00000000000.00000000000.00000000009.86000000000.00710000000.00000000141.1400000000000000 MOPKRW00000.00000000000.00000000000.00000000000.00000000000.00000000173.49000000000.12460000000.00000000008.0245000000000000 OMRKRW00000.00000000000.00000000000.00000000000.00000000000.00000003617.04000000002.59810000000.00000000000.3849000000000000 CLPKRW00000.00000000000.00000000000.00000000000.00000000000.00000000001.44000000000.00100000000.00000000968.4600000000000000 KESKRW00000.00000000000.00000000000.00000000000.00000000000.00000000010.78000000000.00770000000.00000000129.2000000000000000 FJDKRW00000.00000000000.00000000000.00000000000.00000000000.00000000615.56000000000.44210000000.00000000000.4421500000000000 LYDKRW00000.00000000000.00000000000.00000000000.00000000000.00000000257.57000000000.18500000000.00000000005.4051000000000000 RONKRW00000.00000000000.00000000000.00000000000.00000000000.00000000321.90000000000.23120000000.00000000004.3249000000000000 LKRKRW00000.00000000000.00000000000.00000000000.00000000000.00000000004.61000000000.00330000000.00000000301.9500000000000000 ETBKRW00000.00000000000.00000000000.00000000000.00000000000.00000000009.71000000000.00700000000.00000000143.3342000000000000 UZSKRW00000.00000000000.00000000000.00000000000.00000000000.00000000000.11000000000.00010000000.00000012412.9800000000000000 COPKRW00000.00000000000.00000000000.00000000000.00000000000.00000000000.35000000000.00030000000.00000004029.225000000000000000003USDJPY00145.67000000148.45000000144.49000000149.63000000147.060000EURUSD00001.16170000001.18390000001.14970000001.19590000001.172800GBPUSD00001.34040000001.36600000001.32660000001.37980000001.353200@@";

            //ibkEAIPacketResponse _response1 = new ibkEAIPacketResponse(_isHost, _sample, _startPos);

            //logger.Info($"Result: \"{_response1.GetData(_isHost)}\"");

            logger.Info(cFileConfig.EaiIpaddress);
            logger.Info(cFileConfig.EaiListenMac);
            logger.Info(cFileConfig.EaiListenPort);


            try
            {
                logger.Trace($"Assembled Packet : {_sendPacket}");

                logger.Info($"Send Start");

                // localhost ,13000 통신 연결 요청
                TcpClient client = new TcpClient(cFileConfig.EaiIpaddress, cFileConfig.EaiSendPort);

                logger.Info($"Send Start - 2");
                // 입장시 Hello 전달
                Byte[] _data =
                    Encoding.UTF8.GetBytes(_sendPacket);

                logger.Trace($"Assembled Packet - Encoded : {_data}");

                logger.Info($"Send Start - 3");

                NetworkStream stream = client.GetStream();

                logger.Info($"Send End");


                // 서버로 전송
                stream.WriteAsync(_data, 0, _data.Length).GetAwaiter();

                logger.Info($"Send End");
                // 수신 데이터 스트링 선언
                string responseData = string.Empty;

                logger.Info($"Recv Encoding Start");

                Encoding.RegisterProvider(CodePagesEncodingProvider.Instance);
                Encoding euckr = Encoding.GetEncoding(949);

                // First, read the 6-byte length header
                byte[] lengthBuffer = new byte[6];
                int totalBytesRead = 0;
                while (totalBytesRead < 6)
                {
                    int bytesRead = stream.Read(lengthBuffer, totalBytesRead, 6 - totalBytesRead);
                    if (bytesRead == 0) throw new Exception("Connection closed while reading length");
                    totalBytesRead += bytesRead;
                }

                string _length = euckr.GetString(lengthBuffer, 0, 6);
                logger.Info($"Recv Encoding Working 2 " + _length);
                int dataLength = Int32.Parse(_length);
                int totalLength = dataLength + 6;
                logger.Info($"Recv Encoding Working 3 " + totalLength);

                // Now read the rest of the data
                byte[] dataBuffer = new byte[totalLength];
                Buffer.BlockCopy(lengthBuffer, 0, dataBuffer, 0, 6);

                totalBytesRead = 6; // We already have the length header
                while (totalBytesRead < totalLength)
                {
                    int bytesRead = stream.Read(dataBuffer, totalBytesRead, totalLength - totalBytesRead);
                    if (bytesRead == 0) throw new Exception("Connection closed while reading data");
                    totalBytesRead += bytesRead;
                }

                responseData = euckr.GetString(dataBuffer, 0, totalLength);

                logger.Info($"Message received: \"{responseData}\"");

                ibkEAIPacketResponse _response = new ibkEAIPacketResponse(_isHost, responseData, 1463);

                logger.Info($"Currency Count Result: \"{_response.GetData(_isHost)}\"");

                List<ibkEAICurrencyElement>? aaa = _response.GetDataHost();
                if (aaa != null && aaa.Count > 0)
                {
                    foreach (var item in aaa)
                    {
                        CExchangeData20240807 cExchangeData20240807 = new CExchangeData20240807();
                        cExchangeData20240807.BASE_DD = _response.BASE_YMD;
                        cExchangeData20240807.NOTI_TURN_CNT = string.Format("{0:D5}", _response.BLTN_TOB);
                        cExchangeData20240807.CUR = item.CRCD;
                        cExchangeData20240807.DL_BAS_RT = item.BRGN_BASE_RT.ToString();
                        cExchangeData20240807.US_EXCH_RT = item.TSCN_RT.ToString();
                        cExchangeData20240807.TT_BUY_RT = item.TLCB_RT.ToString();
                        cExchangeData20240807.TT_SELL_RT = item.TLCH_SELL_RT.ToString();
                        cExchangeData20240807.CASH_BUY_RT = item.CSH_BNG_RT.ToString();
                        cExchangeData20240807.CASH_SELL_RT = item.CSH_SELL_RT.ToString();
                        logger.Info($"Currency: \"{cExchangeData20240807.CUR}\" DL_BAS_RT: \"{cExchangeData20240807.DL_BAS_RT}\" US_EXCH_RT: \"{cExchangeData20240807.US_EXCH_RT}\" TT_BUY_RT: \"{cExchangeData20240807.TT_BUY_RT}\" TT_SELL_RT: \"{cExchangeData20240807.TT_SELL_RT}\" CASH_BUY_RT: \"{cExchangeData20240807.CASH_BUY_RT}\" CASH_SELL_RT: \"{cExchangeData20240807.CASH_SELL_RT}\"");
                    }
                    
                }

            }
            catch (Exception e)
            {
               logger.Info($"Error: \"{e.Data}\"");
            }


            ///서버 클래스 운영을 위해 떠 있어야 함. 그래서 꺼지지 않게 방지
            Console.ReadLine();
            try
            {
                //threadServer.Abort();

            }
            catch (Exception)
            {

            }
            //threadServer.Join();
        }
    }
}
